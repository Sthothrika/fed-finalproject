<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-0">Admin Dashboard</h1>
  </div>
  <div>
    <a href="/admin/new" class="btn btn-success">Add Resource</a>
  </div>
</div>

<%
  // Defensive defaults to avoid ReferenceError when variables are not provided
  feedbackCount = (typeof feedbackCount !== 'undefined') ? feedbackCount : 0;
  studentCount = (typeof studentCount !== 'undefined') ? studentCount : 0;
  urgencyBreakdown = (typeof urgencyBreakdown !== 'undefined' && urgencyBreakdown) ? urgencyBreakdown : {};
  categoryBreakdown = (typeof categoryBreakdown !== 'undefined' && categoryBreakdown) ? categoryBreakdown : {};
  recentFeedback = (typeof recentFeedback !== 'undefined' && recentFeedback) ? recentFeedback : [];
  topResources = (typeof topResources !== 'undefined' && topResources) ? topResources : [];
  resourceCategoryCounts = (typeof resourceCategoryCounts !== 'undefined' && resourceCategoryCounts) ? resourceCategoryCounts : {};
  recentLogouts = (typeof recentLogouts !== 'undefined' && recentLogouts) ? recentLogouts : [];
  recentSignups = (typeof recentSignups !== 'undefined' && recentSignups) ? recentSignups : [];
%>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card p-3 shadow-sm">
      <h6 class="mb-1">Total Views</h6>
      <div class="fw-bold display-6"><%= typeof totalViews !== 'undefined' ? totalViews : '—' %></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 shadow-sm">
      <h6 class="mb-1">Resources</h6>
      <div class="fw-bold display-6"><%= typeof resourceCount !== 'undefined' ? resourceCount : '—' %></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 shadow-sm">
      <h6 class="mb-1">Students</h6>
      <div class="fw-bold display-6"><%= typeof studentCount !== 'undefined' ? studentCount : '—' %></div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 shadow-sm">
      <h6 class="mb-1">Feedback</h6>
      <div class="fw-bold display-6"><%= typeof feedbackCount !== 'undefined' ? feedbackCount : '0' %></div>
    </div>
  </div>
  <div class="col-md-6 text-end">
    <a href="/admin/metrics" class="btn btn-outline-secondary">View Full Metrics</a>
  </div>
</div>

<table class="table table-striped table-hover shadow-sm">
  <thead>
    <tr>
      <th>Title</th>
      <th>Category</th>
      <th>Views</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <% (resources || []).forEach(function(r){ %>
      <tr>
        <td><%= r.title %></td>
        <td><%= r.category %></td>
        <td><%= r.views || 0 %></td>
        <td class="text-end">
          <a href="/admin/edit/<%= r.id %>" class="btn btn-sm btn-outline-primary me-2">Edit</a>
          <form action="/admin/delete/<%= r.id %>" method="post" style="display:inline-block" onsubmit="return confirm('Delete this resource?');">
            <button class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- Feedback analysis -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card p-3 shadow-sm">
      <h5>Feedback Overview</h5>
      <div class="d-flex gap-3">
        <div>
          <p class="mb-1 small text-muted">Total feedback</p>
          <div class="fw-bold"><%= feedbackCount || 0 %></div>
        </div>
        <div>
          <p class="mb-1 small text-muted">By urgency</p>
          <ul class="small mb-0">
            <% Object.keys(urgencyBreakdown || {}).forEach(function(k){ %>
              <li><strong><%= k %>:</strong> <%= urgencyBreakdown[k] %></li>
            <% }) %>
          </ul>
        </div>
        <div>
          <p class="mb-1 small text-muted">By category</p>
          <ul class="small mb-0">
            <% Object.keys(categoryBreakdown || {}).forEach(function(k){ %>
              <li><strong><%= k %>:</strong> <%= categoryBreakdown[k] %></li>
            <% }) %>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3 shadow-sm">
      <h5>Recent feedback</h5>
      <% if ((recentFeedback || []).length === 0) { %>
        <div class="small text-muted">No feedback yet.</div>
      <% } else { %>
        <ul class="list-group list-group-flush">
          <% recentFeedback.forEach(function(f){ %>
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-bold"><%= f.name || 'Anonymous' %> <% if (f.resolved) { %><span class="badge bg-success ms-2 small">Resolved</span><% } %> <span class="small text-muted">(<%= f.email || '-' %>)</span></div>
                  <div class="small text-muted"><%= f.message.length > 140 ? f.message.substring(0,140) + '...' : f.message %></div>
                  <div class="small text-muted">Urgency: <%= f.urgency || 'low' %> • Category: <%= f.category || 'general' %></div>
                </div>
                <div class="text-end">
                  <form method="post" action="/admin/feedback/resolve/<%= f.id %>" style="display:inline-block">
                    <button class="btn btn-sm btn-outline-primary"><%= f.resolved ? 'Unresolve' : 'Mark Resolved' %></button>
                  </form>
                  <form method="post" action="/admin/feedback/delete/<%= f.id %>" onsubmit="return confirm('Delete feedback?');" style="display:inline-block; margin-left:6px;">
                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
</div>

<!-- Additional analytics -->
<div class="row mt-4">
  <div class="col-md-4">
    <div class="card p-3 shadow-sm">
      <h5>Top Resources</h5>
      <% if ((topResources || []).length === 0) { %>
        <div class="small text-muted">No resources yet.</div>
      <% } else { %>
        <ul class="list-group list-group-flush">
          <% topResources.forEach(function(tr){ %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold"><%= tr.title %></div>
                <div class="small text-muted"><%= tr.category %></div>
              </div>
              <div class="badge bg-light text-dark"><%= tr.views || 0 %></div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 shadow-sm">
      <h5>Resources by Category</h5>
      <% Object.keys(resourceCategoryCounts || {}).length === 0 ? (function(){ %>
        <div class="small text-muted">No resources yet.</div>
      <% })() : (function(){ %>
        <ul class="small mb-0">
          <% Object.keys(resourceCategoryCounts || {}).forEach(function(k){ %>
            <li><strong><%= k %>:</strong> <%= resourceCategoryCounts[k] %></li>
          <% }) %>
        </ul>
      <% })() %>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 shadow-sm">
      <h5>Recent activity</h5>
      <p class="small text-muted mb-2">Recent signups</p>
      <% if ((recentSignups || []).length === 0) { %>
        <div class="small text-muted">No recent signups.</div>
      <% } else { %>
        <ul class="list-group list-group-flush">
          <% recentSignups.forEach(function(s){ %>
            <li class="list-group-item"><strong><%= s.username %></strong> <span class="small text-muted">(<%= s.full_name || '—' %>)</span><div class="small text-muted">Joined: <%= s.created_at %></div></li>
          <% }) %>
        </ul>
      <% } %>
      <hr>
      <p class="small text-muted mb-2">Recent logouts</p>
      <% if ((recentLogouts || []).length === 0) { %>
        <div class="small text-muted">No logout events.</div>
      <% } else { %>
        <ul class="small mb-0">
          <% recentLogouts.forEach(function(l){ %>
            <li><%= l.role %> <strong><%= l.username || '-' %></strong> at <%= l.created_at %> from <%= l.ip || 'unknown' %></li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
</div>

<div class="mt-4">
  <a href="/metrics" class="btn btn-outline-secondary">View Metrics (JSON)</a>
</div>
